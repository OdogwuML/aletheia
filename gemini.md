# gemini.md — Project Constitution

> **This file is LAW.** All schemas, rules, and architectural invariants live here.
> Only update when: a schema changes, a rule is added, or architecture is modified.

---

## Project Overview

- **Project Name:** Aletheia — Property Management System
- **North Star:** A system where landlords can track rent payments across all their buildings, and tenants can make/view their payments.
- **Status:** `Phase 2 — Link (Connectivity)`

---

## Tech Stack

| Layer | Technology |
|-------|-----------|
| Backend | **Golang** |
| Database | **Supabase** (PostgreSQL) |
| Frontend | HTML/CSS/JS (Web App) |
| Payments | **Paystack** |
| Email | **Resend** |
| SMS | **Termii** |
| Hosting | **Vercel** |
| Currency | **₦ (Naira only)** |
| Decentralized Storage | **0G Storage** (0G Labs) |
| Verifiable Ledger | **0G Chain** (Galileo Testnet) |

---

## Data Schema

### Users

```json
{
  "id": "uuid",
  "email": "string",
  "phone": "string",
  "full_name": "string",
  "role": "landlord | tenant",
  "created_at": "timestamp",
  "updated_at": "timestamp"
}
```

### Buildings

```json
{
  "id": "uuid",
  "landlord_id": "uuid (FK → users.id)",
  "name": "string",
  "address": "string",
  "total_units": "integer",
  "created_at": "timestamp"
}
```

### Units

```json
{
  "id": "uuid",
  "building_id": "uuid (FK → buildings.id)",
  "unit_number": "string (e.g. 'A1', '202')",
  "rent_amount": "integer (kobo)",
  "status": "vacant | occupied",
  "tenant_id": "uuid | null (FK → users.id)",
  "lease_start": "date | null",
  "lease_end": "date | null"
}
```

### Payments

```json
{
  "id": "uuid",
  "tenant_id": "uuid (FK → users.id)",
  "unit_id": "uuid (FK → units.id)",
  "building_id": "uuid (FK → buildings.id)",
  "amount": "integer (kobo)",
  "currency": "NGN",
  "payment_method": "card | bank_transfer | ussd",
  "paystack_reference": "string",
  "status": "pending | success | failed",
  "period_label": "string (e.g. 'Feb 2026')",
  "paid_at": "timestamp | null",
  "created_at": "timestamp"
}
```

### Invitations

```json
{
  "id": "uuid",
  "unit_id": "uuid (FK → units.id)",
  "landlord_id": "uuid (FK → users.id)",
  "email": "string | null",
  "phone": "string | null",
  "token": "string (unique invite token)",
  "status": "pending | accepted | expired",
  "created_at": "timestamp",
  "expires_at": "timestamp"
}
```

### Notifications

```json
{
  "id": "uuid",
  "user_id": "uuid (FK → users.id)",
  "channel": "email | sms",
  "type": "payment_receipt | late_reminder | welcome | tenant_invite",
  "payload": "jsonb",
  "sent_at": "timestamp",
  "status": "sent | failed"
}
```

### Maintenance Requests

```json
{
  "id": "uuid",
  "tenant_id": "uuid (FK → users.id)",
  "unit_id": "uuid (FK → units.id)",
  "building_id": "uuid (FK → buildings.id)",
  "title": "string",
  "description": "text",
  "priority": "low | medium | high | urgent",
  "status": "open | in_progress | resolved | closed",
  "created_at": "timestamp",
  "updated_at": "timestamp"
}
```

### Documents

```json
{
  "id": "uuid",
  "uploaded_by": "uuid (FK → users.id)",
  "building_id": "uuid | null (FK → buildings.id)",
  "unit_id": "uuid | null (FK → units.id)",
  "name": "string",
  "type": "lease_agreement | receipt | other",
  "generated": "boolean (true = auto-generated by backend)",
  "file_url": "string (Supabase Storage URL)",
  "og_cid": "string | null (0G Storage Content ID)",
  "og_tx_hash": "string | null (0G Chain transaction hash)",
  "file_size": "integer (bytes)",
  "created_at": "timestamp"
}
```

> **Auto-Generation Note:** Lease agreements are **never uploaded manually**. When a landlord sends a tenant invitation, the backend auto-generates a PDF lease from the unit's data and stores it on **0G Storage**. The `generated` flag distinguishes these auto-contracts from any additional uploads (e.g., receipts).

---

## Behavioral Rules

1. **Tenant Privacy:** Tenants CANNOT see other tenants' payment status. Each tenant only sees their own unit and payment history.
2. **Immutable Payments:** Landlords CANNOT edit or delete past payment records. Payments are append-only.
3. **Automatic Late Reminders:** The system sends automatic late-payment reminders via email (Resend) and SMS (Termii).
4. **Single Currency:** All amounts are in Nigerian Naira (₦). Stored in **kobo** (subunit) — multiply display amounts by 100.
5. **Two-Faced App:** Landlord view and Tenant view are separate interfaces with role-based access.
6. **Export:** Landlords can export payment records as PDF or Excel.
7. **Tenant Invite Flow (Option A):** Landlords invite tenants by entering their email/phone, rent amount, lease start/end dates on a unit. The backend **immediately auto-generates a PDF lease agreement**, uploads it to **0G Storage**, and sends the invite link via email (Resend) or SMS (Termii). Tenant clicks link → signs up → is auto-linked to the unit with a pre-existing lease document.
8. **Maintenance Requests:** Tenants can submit maintenance requests for their unit. Landlords can view and update request status.
9. **Documents:** Lease agreements are **auto-generated** — landlords do NOT manually upload them. **Tenants can view and download their lease agreement** directly from their Tenant Portal (fetched from 0G Storage via CID). Landlords can also upload supplementary documents (e.g. receipts).
10. **Invisible Web3 (0G):** All blockchain interactions are handled by the Go backend using a **Managed Service Wallet**. Landlords and tenants NEVER interact with wallets, private keys, or gas. The system shows a "✓ Secured by 0G" badge where relevant.
11. **Auto-Generated Lease on Invite:** When a landlord invites a tenant, the backend auto-generates a PDF lease using unit data (landlord name, tenant name, address, rent, dates). The PDF is uploaded to **0G Storage** and the CID is saved to `documents`. No manual upload needed.
12. **Verifiable Payment Ledger:** When a Paystack payment is confirmed as `success`, the backend anchors a hash of the receipt metadata to the **0G Chain** (Galileo Testnet). The resulting `tx_hash` links to the public block explorer for tenant/landlord transparency.

---

## Architectural Invariants

1. **3-Layer A.N.T. Architecture** — Architecture (SOPs) → Navigation (routing/reasoning) → Tools (deterministic scripts).
2. **Data-First** — No tool is built until its input/output schema is defined here.
3. **Self-Annealing** — Every error is analyzed → patched → tested → documented so it never recurs.
4. **Deterministic Tools** — All business logic lives in `tools/` as atomic, testable Go code. No guessing.
5. **Intermediates vs. Deliverables** — `.tmp/` is ephemeral. The Payload's final destination is Supabase + Vercel.

---

## Integrations

| Service | Purpose | SDK / Package | Status |
|---------|---------|--------------|--------|
| Paystack | Payments | `github.com/rpip/paystack-go` or direct REST | ❌ Not verified |
| Supabase | Database + Auth | `github.com/supabase-community/supabase-go` | ❌ Not verified |
| Resend | Email notifications | `github.com/resend/resend-go/v3` | ❌ Not verified |
| Termii | SMS notifications | `github.com/Uchencho/go-termii` | ❌ Not verified |
| **0G Storage** | Decentralized document vault | `github.com/0gfoundation/0g-storage-client` | ❌ Not verified |
| **0G Chain** | Verifiable payment ledger (Galileo Testnet) | `go-ethereum` ethclient + RPC `https://evmrpc-testnet.0g.ai` | ❌ Not verified |
| **GoFPDF** | PDF lease agreement generation | `github.com/go-pdf/fpdf` | ❌ Not verified |

### 0G Labs: Architecture Notes

**Strategy:** Managed Service Wallet ("Invisible Web3")
- The backend holds a single `OG_SERVICE_WALLET_PRIVATE_KEY` in `.env`.
- This wallet pays all gas fees and signs all 0G transactions on behalf of DumApp.
- Neither landlords nor tenants need a Web3 wallet.

**0G Storage Flow — Auto-Generated Lease Agreement:**
1. Landlord sends tenant invite (enters email/phone, rent, lease dates) via DumApp UI
2. Backend generates PDF lease using `GoFPDF` — interpolates landlord name, tenant info, unit address, rent amount, lease period
3. Backend uploads the PDF bytes to **0G Storage** via `0g-storage-client` (service wallet pays gas)
4. 0G returns a `CID` → saved to `documents.og_cid` in Supabase (`generated = true`)
5. Invite link is sent via Resend/Termii — tenant can click "View Lease" inside DumApp before even signing up
6. Frontend shows a "✓ Secured by 0G" badge on the lease document

**0G Chain Flow:**
1. Paystack webhook confirms payment success → Go backend generates a hash of the receipt
2. Backend signs a transaction with the service wallet → submits to 0G Galileo Testnet
3. 0G Chain returns a `tx_hash` → displayed in the payment UI as "Chain Verified"

**Required `.env` variables:**
```bash
OG_SERVICE_WALLET_PRIVATE_KEY=   # The single app-level wallet private key
OG_RPC_URL=https://evmrpc-testnet.0g.ai
OG_STORAGE_NODE_URL=             # 0G Storage node endpoint (to be configured)
```

---

## Changelog

| Date | Change |
|------|--------|
| 2026-02-20 | Protocol 0: Initialization — file created with discovery answers and data schema |
| 2026-02-20 | Added Invitations table + tenant invite flow (Option A) to schema and behavioral rules |
| 2026-02-20 | Added Maintenance Requests + Documents tables. Dropped: Building Manager, Property Type, Building Map |
| 2026-02-21 | Phase 1 → Phase 2. Database schema verified in Supabase. Security patch applied to `handle_updated_at`. |
| 2026-02-21 | **0G Labs hackathon integration added.** Decentralized Storage + Verifiable Ledger via Managed Service Wallet ("Invisible Web3"). Added `og_cid` + `og_tx_hash` fields to Documents schema. Added rules #10, #11, #12. |
| 2026-02-21 | **Auto-Generated Lease Agreement added.** Lease PDFs are now generated by Go backend (`GoFPDF`) on tenant invite and stored directly on 0G Storage. No manual upload. Added `generated` flag to Documents schema. Updated rules #7, #9, #11. |
